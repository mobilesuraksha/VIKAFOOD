<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>VIKA</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#ea580c">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;700;800;900&display=swap" rel="stylesheet">
    
    <style>body { font-family: 'Outfit', sans-serif; background-color: #f8fafc; padding-bottom: 110px; } .hide-scroll::-webkit-scrollbar { display: none; } .glass-card { background: white; border: 1px solid #f1f5f9; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05); } .cat-chip.active { background: #0f172a; color: white; } .slide-up { animation: slideUp 0.4s forwards; } @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } } .fade-in { animation: fadeIn 0.5s forwards; } @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } } .skeleton { background: linear-gradient(90deg, #f1f5f9 25%, #e2e8f0 50%, #f1f5f9 75%); background-size: 200% 100%; animation: shimmer 1.5s infinite; } @keyframes shimmer { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }</style>
</head>
<body class="bg-slate-50 select-none text-slate-800">

    <div id="installBanner" class="hidden fixed top-0 w-full bg-slate-900 text-white px-5 py-3 flex justify-between items-center z-[100] border-b border-white/10 slide-up shadow-xl"><div class="flex items-center gap-3"><div class="bg-orange-600 w-9 h-9 rounded-xl flex items-center justify-center font-black italic shadow-lg text-white app-logo">V</div><div><p class="text-[11px] font-bold leading-none app-name">VIKA APP</p><p class="text-[9px] text-slate-400 font-bold uppercase tracking-widest mt-1">Get Faster Delivery</p></div></div><button id="installBtn" class="bg-orange-600 px-5 py-2 rounded-xl text-[11px] font-black shadow-lg hover:scale-105 transition text-white">INSTALL</button></div>
    <div id="notifPanel" class="fixed inset-0 bg-slate-900/60 z-[999] hidden flex justify-end backdrop-blur-sm transition-opacity"><div class="bg-white w-4/5 max-w-sm h-full shadow-2xl p-6 overflow-y-auto slide-up rounded-l-[2.5rem]"><div class="flex justify-between items-center mb-6"><h2 class="text-2xl font-black text-slate-800">Notifications</h2><button onclick="document.getElementById('notifPanel').classList.add('hidden')" class="w-10 h-10 bg-slate-100 rounded-full flex items-center justify-center hover:bg-slate-200"><i class="fas fa-times"></i></button></div><div id="notifList" class="space-y-3"><div class="text-center py-10 opacity-50"><i class="fas fa-bell-slash text-4xl mb-2"></i><p class="text-xs font-bold">No new alerts</p></div></div></div></div>

    <header class="glass-header sticky top-0 z-40 px-5 py-3 flex justify-between items-center shadow-sm">
        <div class="flex items-center gap-3">
            <div class="bg-orange-600 text-white w-10 h-10 rounded-xl flex items-center justify-center font-black italic shadow-lg shadow-orange-200 text-lg app-logo">V</div>
            <div><h1 class="text-lg font-black italic tracking-tighter text-slate-900 leading-none app-name">VIKA</h1><p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest" id="welcomeMsg">Guest</p></div>
        </div>
        <div class="flex items-center gap-3">
            <div class="relative cursor-pointer p-2 rounded-full hover:bg-slate-100 transition" onclick="document.getElementById('notifPanel').classList.remove('hidden'); document.getElementById('notifDot').classList.add('hidden');">
                <i class="fas fa-bell text-xl text-slate-600"></i><span id="notifDot" class="absolute top-1 right-2 w-2.5 h-2.5 bg-red-500 rounded-full border-2 border-white hidden"><span class="absolute inline-flex h-full w-full rounded-full bg-red-400 opacity-75 animate-ping"></span></span>
            </div>
            <div class="relative cursor-pointer hover:scale-95 transition" onclick="openCart()">
                <div class="w-11 h-11 bg-slate-900 text-white rounded-full flex items-center justify-center shadow-lg"><i class="fas fa-shopping-basket text-lg"></i></div><span id="cartCount" class="absolute -top-1 -right-1 bg-red-600 text-white text-[10px] w-5 h-5 flex items-center justify-center rounded-full font-bold border-2 border-white shadow-sm">0</span>
            </div>
        </div>
    </header>

    <div id="view-home" class="fade-in">
        <div class="px-4 pt-4 relative"><i class="fas fa-search absolute left-8 top-1/2 -translate-y-1/2 text-slate-400"></i><input id="search" placeholder="Search items..." class="w-full bg-white pl-12 py-3.5 rounded-2xl shadow-sm border border-slate-100 font-bold outline-none text-sm focus:border-orange-500 focus:ring-4 ring-orange-50 transition placeholder-slate-400"></div>
        <div class="mt-6 px-4"><div class="w-full h-44 rounded-[2rem] bg-gradient-to-r from-orange-500 to-red-600 overflow-hidden relative shadow-xl"><div class="absolute inset-0 bg-[url('https://source.unsplash.com/random/800x400/?food')] bg-cover opacity-20 mix-blend-overlay"></div><div class="absolute bottom-6 left-6 z-20 text-white"><span class="bg-white/20 backdrop-blur-md px-3 py-1 rounded-lg text-[10px] font-black uppercase tracking-widest border border-white/20">Special</span><h2 class="text-3xl font-black italic mt-2 leading-none drop-shadow-md app-name">VIKA</h2><p class="text-white/90 text-xs font-bold mt-1">Super Fast Delivery</p></div></div></div>
        <div class="px-4 mt-6"><div class="flex gap-3 overflow-x-auto hide-scroll pb-2"><button onclick="filterCat('All')" id="cat-All" class="cat-chip active px-6 py-2.5 rounded-xl text-xs font-bold">üî• All</button><button onclick="filterCat('Food')" id="cat-Food" class="cat-chip px-6 py-2.5 rounded-xl text-xs font-bold">üçî Food</button><button onclick="filterCat('Grocery')" id="cat-Grocery" class="cat-chip px-6 py-2.5 rounded-xl text-xs font-bold">ü•¨ Grocery</button></div></div>
        <div class="px-4 mt-6"><div class="flex justify-between items-center mb-3"><h3 class="font-black text-slate-800 text-lg">Menu & Offers</h3></div><main id="productGrid" class="grid grid-cols-2 md:grid-cols-3 gap-4 pb-4"></main></div>
    </div>

    <div id="view-hist" class="hidden px-4 pt-6 pb-32 fade-in">
        <div class="flex justify-between items-end mb-6"><h2 class="text-3xl font-black text-slate-800">My Orders</h2><div class="text-right"><p class="text-[10px] text-slate-400 font-bold uppercase tracking-widest">Total</p><p class="text-2xl font-black text-orange-600 leading-none" id="totalOrdersCount">0</p></div></div>
        <div class="bg-white p-2 rounded-2xl shadow-sm border border-slate-100 mb-6 flex justify-between divide-x divide-slate-100"><div class="text-center w-1/2 cursor-pointer" onclick="view('hist')"><p class="text-[10px] text-blue-500 font-bold uppercase">Active</p><p class="text-lg font-black text-slate-800" id="activeOrdersCount">0</p></div><div class="text-center w-1/2 cursor-pointer" onclick="view('hist')"><p class="text-[10px] text-gray-400 font-bold uppercase">Past</p><p class="text-lg font-black text-slate-800" id="completedOrdersCount">0</p></div></div>
        <div id="historyList" class="space-y-4"></div>
    </div>

    <div id="view-offers" class="hidden px-4 pt-6 pb-32 fade-in"><h2 class="text-3xl font-black text-slate-800 mb-6">Hot Deals üî•</h2><div id="offersGrid" class="grid grid-cols-2 gap-4"></div></div>

    <div id="cartModal" class="fixed inset-0 bg-slate-900/80 hidden z-[60] flex items-end sm:items-center justify-center p-0 sm:p-4 backdrop-blur-md transition-all">
        <div class="bg-white w-full max-w-md rounded-t-[2.5rem] sm:rounded-[2.5rem] p-6 max-h-[95vh] overflow-y-auto slide-up shadow-2xl relative">
            <div class="flex justify-between items-center mb-6"><h2 class="text-2xl font-black italic">Your Cart</h2><button onclick="document.getElementById('cartModal').classList.add('hidden')" class="w-9 h-9 rounded-full bg-slate-100 flex items-center justify-center hover:bg-slate-200 transition"><i class="fas fa-times"></i></button></div>
            <div id="cartList" class="space-y-4 mb-6"></div>
            
            <div class="mb-4">
                <p class="text-xs font-bold text-slate-400 uppercase mb-2">Payment Method</p>
                <div class="flex gap-2">
                    <label onclick="togglePayment('COD')" class="flex-1 border-2 border-slate-200 p-3 rounded-xl cursor-pointer has-[:checked]:border-green-500 has-[:checked]:bg-green-50 transition">
                        <input type="radio" name="payMode" value="COD" class="hidden" checked>
                        <div class="text-center"><i class="fas fa-money-bill-wave mb-1 text-green-600"></i><p class="text-xs font-bold">Cash</p></div>
                    </label>
                    <label onclick="togglePayment('UPI')" class="flex-1 border-2 border-slate-200 p-3 rounded-xl cursor-pointer has-[:checked]:border-blue-500 has-[:checked]:bg-blue-50 transition">
                        <input type="radio" name="payMode" value="UPI" class="hidden">
                        <div class="text-center"><i class="fas fa-qrcode mb-1 text-blue-600"></i><p class="text-xs font-bold">UPI / QR</p></div>
                    </label>
                </div>
            </div>

            <div id="qrSection" class="hidden bg-slate-50 p-4 rounded-xl border border-slate-200 mb-4 text-center">
                <p class="text-xs font-bold text-slate-500 mb-3">Scan & Pay: <span class="text-black text-lg" id="qrAmount">‚Çπ0</span></p>
                <div class="bg-white p-2 rounded-lg inline-block shadow-sm border">
                    <img id="upiQrCode" src="" class="w-40 h-40 object-contain mx-auto" alt="Generating QR...">
                </div>
                <p class="text-[10px] text-slate-400 mt-2 font-bold mb-3" id="upiIdDisplay"></p>
                <button onclick="openUpiApp()" class="w-full bg-blue-600 text-white py-3 rounded-xl font-bold text-xs mb-4 shadow-lg flex items-center justify-center gap-2"><i class="fas fa-mobile-alt"></i> PAY VIA APP</button>
                <div class="text-left"><label class="text-[10px] font-bold text-slate-500 uppercase ml-1">Enter UTR / Transaction ID (Required)</label><input id="utrInput" placeholder="e.g. 321456789012" class="w-full border-2 border-slate-200 p-3 rounded-xl text-sm font-bold outline-none focus:border-blue-500 mt-1"></div>
            </div>

            <div class="border-t border-slate-100 pt-6 space-y-4">
                <input id="orderName" placeholder="Your Name" class="w-full bg-slate-50 p-4 rounded-2xl text-sm font-bold border border-slate-100 outline-none"><input id="orderPhone" type="number" placeholder="Mobile Number" class="w-full bg-slate-50 p-4 rounded-2xl text-sm font-bold border border-slate-100 outline-none"><button onclick="window.getLocation()" id="locBtn" class="w-full py-4 bg-blue-50 text-blue-600 rounded-2xl text-xs font-black flex items-center justify-center gap-2 border border-blue-100 hover:bg-blue-100 transition shadow-sm"><i class="fas fa-location-crosshairs"></i> DETECT GPS</button><textarea id="cAddr" placeholder="Full Address..." class="w-full bg-slate-50 p-4 rounded-2xl text-sm font-bold border border-slate-100 outline-none h-24 resize-none"></textarea>
                <button id="placeOrderBtn" class="w-full bg-slate-900 text-white py-4 rounded-2xl font-black shadow-xl mt-2 flex justify-between px-8 items-center hover:scale-[1.02] transition"><span>PLACE ORDER</span><span class="bg-white/20 px-2 py-1 rounded text-xs" id="totalPrice">‚Çπ0</span></button>
            </div>
        </div>
    </div>

    <div id="authModal" class="fixed inset-0 bg-slate-900/90 z-[999] flex items-center justify-center p-6 hidden backdrop-blur-md"><div class="bg-white w-full max-w-sm rounded-[2.5rem] p-8 text-center shadow-2xl slide-up"><div class="w-20 h-20 bg-orange-100 rounded-full flex items-center justify-center mx-auto mb-6 text-4xl animate-bounce app-logo">V</div><h2 class="text-3xl font-black text-slate-800 mb-2">Welcome!</h2><p class="text-xs text-slate-400 font-bold mb-8 uppercase tracking-widest">Login to continue</p><input id="uName" placeholder="Name" class="w-full bg-slate-50 p-4 rounded-2xl font-bold mb-3 border"><input id="uPhone" type="tel" placeholder="Mobile" class="w-full bg-slate-50 p-4 rounded-2xl font-bold mb-6 border"><button id="saveUserBtn" class="w-full bg-slate-900 text-white py-4 rounded-2xl font-bold shadow-xl">GET STARTED</button></div></div>

    <div class="fixed bottom-0 w-full bg-white/95 backdrop-blur-md border-t border-slate-100 px-6 py-2 flex justify-between items-center z-40 pb-6 shadow-[0_-5px_20px_-5px_rgba(0,0,0,0.05)]"><button onclick="view('home')" id="nav-home" class="text-orange-600 flex flex-col items-center gap-1 transition-all"><i class="fas fa-home text-xl"></i><span class="text-[10px] font-bold">Home</span></button><button onclick="view('offers')" id="nav-offers" class="text-slate-400 flex flex-col items-center gap-1 transition-all"><i class="fas fa-tags text-xl"></i><span class="text-[10px] font-bold">Offers</span></button><div class="relative -top-8 card-tap"><button onclick="openCart()" class="bg-slate-900 text-white w-14 h-14 rounded-full flex items-center justify-center shadow-2xl shadow-slate-400 border-4 border-slate-50 text-xl"><i class="fas fa-shopping-basket"></i></button></div><button onclick="view('hist')" id="nav-hist" class="text-slate-400 flex flex-col items-center gap-1 transition-all"><i class="fas fa-history text-xl"></i><span class="text-[10px] font-bold">Orders</span></button><a href="#" id="waLink" class="text-slate-400 flex flex-col items-center gap-1 transition-all hover:text-green-500"><i class="fab fa-whatsapp text-xl"></i><span class="text-[10px] font-bold">Help</span></a></div>

    <div id="toast" class="fixed top-24 left-4 right-4 bg-slate-900 text-white p-4 rounded-2xl shadow-2xl z-[100] hidden slide-up flex items-center gap-4 border border-slate-700"><div class="bg-green-500 w-10 h-10 rounded-full flex items-center justify-center flex-shrink-0 shadow-lg"><i class="fas fa-check"></i></div><div><h4 class="font-bold text-sm" id="toastTitle">Notification</h4><p class="text-xs text-slate-300" id="toastMsg">Message</p></div></div>
    <audio id="notifSound" src="sound/user_sound.mp3"></audio>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, where, orderBy, doc, updateDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        let globalSettings = { shopName: "VIKA", logoUrl: "", upiId: "RISHABHSISODIYA1998@YBL" };

        const firebaseConfig = { apiKey: "AIzaSyARK1SBVFmjEeqsPdficWzszf6AT1TKZQ8", authDomain: "singleapp-207e3.firebaseapp.com", projectId: "singleapp-207e3", storageBucket: "singleapp-207e3.firebasestorage.app", messagingSenderId: "1026534886749", appId: "1:1026534886749:web:52c3aa09e21a65f9342cb4", measurementId: "G-PPYBRX43TY" };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        window.products = []; window.cart = JSON.parse(localStorage.getItem('cart')) || []; window.user = JSON.parse(localStorage.getItem('user'));
        let filterCatName = 'All'; let lastOrdersState = {};

        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => { e.preventDefault(); deferredPrompt = e; document.getElementById('installBanner').classList.remove('hidden'); });
        document.getElementById('installBtn').onclick = async () => { if (deferredPrompt) { deferredPrompt.prompt(); } };

        if(!window.user) document.getElementById('authModal').classList.remove('hidden');
        else document.getElementById('welcomeMsg').innerText = `Hi, ${window.user.name.split(' ')[0]}`;
        
        document.getElementById('saveUserBtn').onclick = () => { let n = document.getElementById('uName').value, p = document.getElementById('uPhone').value; if (n && p) { localStorage.setItem('user', JSON.stringify({ name: n, phone: p })); location.reload(); } };

        // Fetch Global Settings
        onSnapshot(doc(db, "settings", "global"), (doc) => {
            if(doc.exists()){ 
                let s = doc.data(); 
                if(s.shopName) globalSettings.shopName = s.shopName;
                if(s.logoUrl) globalSettings.logoUrl = s.logoUrl;
                if(s.upiId) globalSettings.upiId = s.upiId;
                document.querySelectorAll('.app-name').forEach(el => el.innerText = globalSettings.shopName);
                document.querySelectorAll('.app-logo').forEach(el => { 
                    if(globalSettings.logoUrl) {
                        el.innerHTML = `<img src="${globalSettings.logoUrl}" class="w-full h-full object-cover rounded-xl">`; 
                        el.classList.remove('bg-orange-600','text-white'); 
                    } else {
                        el.innerHTML = globalSettings.shopName.charAt(0).toUpperCase();
                        el.classList.add('bg-orange-600','text-white');
                    }
                });
            }
        });

        onSnapshot(collection(db, "products"), (snap) => { window.products = snap.docs.map(d => ({id:d.id, ...d.data()})); renderProducts(); renderOffers(); });

        if(window.user) {
            onSnapshot(query(collection(db, "orders"), where("customer.phone", "==", window.user.phone)), (snap) => {
                let orders = snap.docs.map(d => ({id:d.id, ...d.data()})).sort((a,b)=>b.timestamp-a.timestamp);
                checkUpdates(orders); renderHistory(orders);
                document.getElementById('totalOrdersCount').innerText = orders.length;
                document.getElementById('activeOrdersCount').innerText = orders.filter(o=>o.status!=='Delivered' && o.status!=='Cancelled').length;
                document.getElementById('completedOrdersCount').innerText = orders.filter(o=>o.status==='Delivered').length;
            });
        }

        function checkUpdates(orders) {
            let notifHTML = '';
            orders.forEach(o => {
                if(lastOrdersState[o.id] && lastOrdersState[o.id] !== o.status) { showToast("Order Update", `Order #${o.id.substr(0,4)} is now ${o.status}`); document.getElementById('notifSound').play().catch(()=>{}); document.getElementById('notifDot').classList.remove('hidden'); }
                lastOrdersState[o.id] = o.status;
                if(o.timeline) { [...o.timeline].reverse().slice(0,3).forEach(t => { notifHTML += `<div class="bg-slate-50 p-4 rounded-2xl border border-slate-100 shadow-sm"><p class="font-bold text-sm text-slate-800">${t.msg}</p><div class="flex justify-between mt-1"><span class="text-[10px] bg-slate-200 px-2 rounded font-bold">#${o.id.substr(0,4)}</span><span class="text-[10px] text-gray-400">${t.time}</span></div></div>`; }); }
            });
            if(notifHTML) document.getElementById('notifList').innerHTML = notifHTML;
        }

        function renderProducts() {
            let list = window.products, s = document.getElementById('search').value.toLowerCase();
            if(filterCatName !== 'All') list = list.filter(p => p.cat === filterCatName);
            if(s) list = list.filter(p => p.name.toLowerCase().includes(s));
            document.getElementById('productGrid').innerHTML = list.map(p => {
                let qty = window.cart.find(c=>c.id==p.id)?.qty || 0;
                let priceHtml = p.offerPrice ? `<span class="line-through text-xs text-gray-400 mr-1">‚Çπ${p.price}</span><span class="font-black text-red-600">‚Çπ${p.offerPrice}</span>` : `‚Çπ${p.price}`;
                return `<div class="bg-white p-3 rounded-[1.5rem] glass-card flex flex-col card-tap"><div class="h-32 bg-slate-100 rounded-2xl mb-2 overflow-hidden relative"><img src="${p.img}" onerror="this.src='https://via.placeholder.com/150?text=No+Image'" class="w-full h-full object-cover"></div><h3 class="font-bold text-sm truncate">${p.name}</h3><div class="flex justify-between items-center mt-2"><div>${priceHtml}</div>${qty==0 ? `<button onclick="window.modQty('${p.id}',1)" class="bg-slate-900 text-white w-8 h-8 rounded-lg shadow-lg">+</button>`:`<div class="flex items-center gap-2 bg-slate-100 rounded-lg p-1"><button onclick="window.modQty('${p.id}',-1)" class="px-1 font-bold">-</button><span class="font-bold text-xs">${qty}</span><button onclick="window.modQty('${p.id}',1)" class="px-1 font-bold">+</button></div>`}</div></div>`;
            }).join('') || '<div class="col-span-full text-center py-10 opacity-50">No items found</div>';
            document.getElementById('cartCount').innerText = window.cart.reduce((a,b)=>a+b.qty,0);
        }

        function renderOffers() { document.getElementById('offersGrid').innerHTML = window.products.filter(p=>p.offerPrice).map(p=>`<div class="bg-white p-3 rounded-[1.5rem] shadow-sm border border-red-100 relative"><span class="absolute top-2 right-2 bg-red-500 text-white text-[10px] px-2 rounded font-bold">OFFER</span><img src="${p.img}" onerror="this.src='https://via.placeholder.com/150?text=No+Image'" class="w-full h-32 object-cover rounded-xl mb-2"><h3 class="font-bold text-sm">${p.name}</h3><div class="font-black text-red-600">‚Çπ${p.offerPrice}</div><button onclick="window.modQty('${p.id}',1)" class="w-full bg-red-50 text-red-600 font-bold text-xs py-2 rounded-lg mt-2">ADD TO CART</button></div>`).join(''); }

        function renderHistory(orders) {
            document.getElementById('historyList').innerHTML = orders.map(o => {
                let statusColor = o.status==='Pending'?'text-red-500 bg-red-50 border-red-100':(o.status==='Delivered'?'text-green-600 bg-green-50 border-green-100':'text-blue-600 bg-blue-50 border-blue-100');
                let trackBtn = (['Out for Delivery','Arrived'].includes(o.status) && o.riderLat) ? `<a href="https://www.google.com/maps/search/?api=1&query=${o.riderLat},${o.riderLng}" target="_blank" class="block bg-green-500 text-white text-center py-2 rounded-xl mt-2 font-bold text-xs animate-pulse">TRACK LIVE RIDER</a>` : '';
                let cancelBtn = (o.status==='Pending') ? `<button onclick="window.cancelOrder('${o.id}')" class="w-full mt-3 border border-red-200 text-red-500 py-2 rounded-xl text-xs font-bold">CANCEL ORDER</button>` : '';
                let payBadge = o.paymentMethod === 'UPI' ? 'üü£ UPI' : 'üü¢ Cash';
                return `<div class="bg-white p-5 rounded-[1.5rem] shadow-sm border border-slate-100 transition hover:shadow-md"><div class="flex justify-between items-center mb-3 pb-3 border-b border-slate-50"><span class="font-black text-slate-800 text-lg">#${o.id.substr(0,4)}</span><span class="px-3 py-1 rounded-lg text-[10px] uppercase font-bold border ${statusColor}">${o.status}</span></div><div class="bg-slate-50 p-3 rounded-xl mb-3"><p class="text-xs font-bold text-slate-500 leading-relaxed">${o.items.map(i=>`${i.name} (x${i.qty})`).join(', ')}</p></div><div class="flex justify-between items-center"><span class="text-xs font-bold text-slate-400">${payBadge} | ${o.date}</span><span class="text-lg font-black text-slate-900">‚Çπ${o.total}</span></div>${trackBtn}${cancelBtn}</div>`;
            }).join('');
        }

        window.togglePayment = (mode) => {
            if(mode === 'UPI') {
                document.getElementById('qrSection').classList.remove('hidden');
                let total = window.cart.reduce((a,b)=>a+(b.offerPrice||b.price)*b.qty,0);
                document.getElementById('qrAmount').innerText = '‚Çπ' + total;
                document.getElementById('upiIdDisplay').innerText = globalSettings.upiId;
                let upiLink = `upi://pay?pa=${globalSettings.upiId}&pn=${globalSettings.shopName}&am=${total}&cu=INR`;
                document.getElementById('upiQrCode').src = `https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(upiLink)}`;
            } else {
                document.getElementById('qrSection').classList.add('hidden');
            }
        }

        window.openUpiApp = () => {
            let total = window.cart.reduce((a,b)=>a+(b.offerPrice||b.price)*b.qty,0);
            let upiLink = `upi://pay?pa=${globalSettings.upiId}&pn=${globalSettings.shopName}&am=${total}&cu=INR`;
            window.location.href = upiLink;
        }

        window.modQty = (id, n) => { let p=window.products.find(x=>x.id==id), item=window.cart.find(x=>x.id==id); if(item) { item.qty += n; if(item.qty<=0) window.cart = window.cart.filter(x=>x.id!=id); } else { window.cart.push({...p, qty:1}); } localStorage.setItem('cart', JSON.stringify(window.cart)); renderProducts(); renderOffers(); if(!document.getElementById('cartModal').classList.contains('hidden')) window.openCart(); };
        window.openCart = () => { if(!window.cart.length) return alert("Empty"); if(window.user){document.getElementById('orderName').value=window.user.name;document.getElementById('orderPhone').value=window.user.phone;} document.getElementById('cartList').innerHTML = window.cart.map(i=>`<div class="flex justify-between text-sm border-b pb-2"><span>${i.name} x${i.qty}</span><span>‚Çπ${(i.offerPrice||i.price)*i.qty}</span></div>`).join(''); document.getElementById('totalPrice').innerText = '‚Çπ'+window.cart.reduce((a,b)=>a+(b.offerPrice||b.price)*b.qty,0); document.getElementById('cartModal').classList.remove('hidden'); togglePayment('COD'); };
        
        document.getElementById('placeOrderBtn').onclick = async () => { 
            let name=document.getElementById('orderName').value, phone=document.getElementById('orderPhone').value, addr=document.getElementById('cAddr').value;
            let payMode = document.querySelector('input[name="payMode"]:checked').value;
            let utr = document.getElementById('utrInput').value;

            if(!name||!phone||!addr) return alert("Fill details"); 
            if(payMode === 'UPI' && !utr) return alert("Please enter UTR/Transaction ID for Verification");

            let total = window.cart.reduce((a,b)=>a+(b.offerPrice||b.price)*b.qty,0); 
            
            await addDoc(collection(db,"orders"), {
                customer:{name,phone,addr,lat:window.userLat,lng:window.userLng}, 
                items:window.cart, 
                total, 
                status:'Pending', 
                paymentMethod: payMode,
                utr: utr || '',
                paymentVerified: false,
                amountToCollect: (payMode==='UPI' ? total : total), 
                timestamp:Date.now(), 
                date:new Date().toLocaleString(), 
                timeline:[{status:'Pending',msg:'Order Placed',time:new Date().toLocaleTimeString()}]
            }); 
            window.cart=[]; localStorage.removeItem('cart'); document.getElementById('cartModal').classList.add('hidden'); renderProducts(); showToast("Success","Order Placed!"); window.view('hist'); 
        };
        
        window.cancelOrder = async (id) => { if(confirm("Cancel?")) await updateDoc(doc(db,"orders",id), {status:'Cancelled'}); };
        window.getLocation = () => { navigator.geolocation.getCurrentPosition(p=>{window.userLat=p.coords.latitude;window.userLng=p.coords.longitude;document.getElementById('locBtn').innerText="Locked ‚úì";}); };
        window.view = (v) => { ['home','hist','offers'].forEach(x=> { document.getElementById('view-'+x).classList.add('hidden'); document.getElementById('nav-'+x).classList.remove('text-orange-600'); }); document.getElementById('view-'+v).classList.remove('hidden'); document.getElementById('nav-'+v).classList.add('text-orange-600'); };
        window.filterCat = (c) => { filterCatName = c; document.querySelectorAll('.cat-chip').forEach(el=>el.classList.remove('active')); document.getElementById('cat-'+c).classList.add('active'); renderProducts(); };
        window.showToast = (t,m) => { document.getElementById('toastTitle').innerText=t; document.getElementById('toastMsg').innerText=m; document.getElementById('toast').classList.remove('hidden'); setTimeout(()=>document.getElementById('toast').classList.add('hidden'), 3000); };
        document.getElementById('search').addEventListener('input', renderProducts);
    </script>
</body>
</html>